version: '3.8'

services:
  # Catalog API
  catalog-api:
    build:
      context: ../../
      dockerfile: deploy/docker/Dockerfile.api
    ports:
      - "8080:8080"
      - "8081:8081"  # HTTPS
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080;https://+:8081
      - ConnectionStrings__CatalogDatabase=Server=sqledge;Database=CatalogDb;User Id=sa;Password=${DB_PASSWORD};TrustServerCertificate=True;
      - Auth__Authority=${AUTH_AUTHORITY:-https://localhost:5001}
      - Auth__Audience=${AUTH_AUDIENCE:-catalog-api}
      - IpRateLimiting__EnableEndpointRateLimiting=true
      - IpRateLimiting__GeneralRules__0__Endpoint=*
      - IpRateLimiting__GeneralRules__0__Period=1m
      - IpRateLimiting__GeneralRules__0__Limit=100
      - IpRateLimiting__GeneralRules__1__Endpoint=*
      - IpRateLimiting__GeneralRules__1__Period=1h
      - IpRateLimiting__GeneralRules__1__Limit=1000
    depends_on:
      sqledge:
        condition: service_healthy
    networks:
      - catalog-network
    restart: unless-stopped

  # Azure SQL Edge (SQL Server for Linux containers)
  sqledge:
    image: mcr.microsoft.com/azure-sql-edge:latest
    ports:
      - "1433:1433"
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=${DB_PASSWORD}
      - MSSQL_PID=Developer
    volumes:
      - sqledge_data:/var/opt/mssql
      - ../../deploy/docker/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    networks:
      - catalog-network
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P ${DB_PASSWORD} -Q 'SELECT 1'"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # OpenTelemetry Collector
  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    ports:
      - "4317:4317"  # OTLP gRPC
      - "4318:4318"  # OTLP HTTP
      - "8888:8888"  # Metrics endpoint
      - "9411:9411"  # Zipkin
    volumes:
      - ./otel-collector.yaml:/etc/otelcol-contrib/config.yaml
    command: ["--config=/etc/otelcol-contrib/config.yaml"]
    depends_on:
      - jaeger
    networks:
      - catalog-network
    restart: unless-stopped

  # Jaeger (Tracing UI)
  jaeger:
    image: jaegertracing/all-in-one:latest
    ports:
      - "16686:16686"  # Jaeger UI
      - "14268:14268"  # Jaeger HTTP
    environment:
      - COLLECTOR_OTLP_ENABLED=true
      - COLLECTOR_ZIPKIN_HOST_PORT=:9411
    volumes:
      - jaeger_data:/tmp
    networks:
      - catalog-network
    restart: unless-stopped

volumes:
  sqledge_data:
  jaeger_data:

networks:
  catalog-network:
    driver: bridge
